# 1. المرحلة الأساسية: استخدام صورة Python رسمية كقاعدة
# نستخدم python:3.11-slim لأنها صغيرة ومستقرة ومناسبة لـ Cloud Run
FROM python:3.11-slim

# 2. إعداد متغيرات البيئة الأساسية
# هذا يضمن أن يتم عرض مخرجات Python مباشرة في سجلات Cloud Run
ENV PYTHONUNBUFFERED=1

# 3. إنشاء دليل العمل داخل الحاوية
# هنا سيتم نسخ الكود الخاص بك إليه
WORKDIR /app

# 4. نسخ ملف المتطلبات أولاً
# هذا يسمح لـ Docker بتخزين طبقة التبعيات مؤقتًا إذا لم تتغير
COPY requirements.txt .

# 5. تثبيت التبعيات
# تثبيت كل المكتبات المذكورة في requirements.txt
RUN pip install -r requirements.txt

# 6. نسخ الكود المتبقي
# نسخ app.py، وملفات static (مثل public/index.html)، وملفات .env
# ملاحظة: ملف .env لن يُستخدم في Cloud Run، لكن ننسخه لضمان تطابق البيئة المحلية.
COPY . .

# 7. الكشف عن المنفذ
# هذا يخبر Docker أن التطبيق يستمع على المنفذ 8080، وهو المنفذ الافتراضي في Cloud Run
EXPOSE 8080

# 8. أمر التشغيل
# هذا هو الأمر الذي يتم تنفيذه عند بدء الحاوية.
# نستخدم Gunicorn كخادم إنتاج لتشغيل تطبيق Flask بأداء أفضل من 'flask run'.
# يجب أن يكون ملف .env متاحًا لـ gunicorn.
CMD ["gunicorn", "--bind", "0.0.0.0:8080", "app:app"]
